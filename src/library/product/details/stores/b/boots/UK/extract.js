const { transform } = require('../format.js');
async function implementation(
  inputs,
  parameters,
  context,
  dependencies,
) {
  context.setCookie(
    {
      name: 'hasGmid',
      value: 'ver3',
    },
    {
      name: 'ucid',
      value: 'a3JDvyOG3ffGuBe2QbQ-oQ',
    },
    {
      name: '_gat_UA-41493563-6',
      value: '1',
    },
    {
      name: 'JSESSIONID',
      value: '00005krsmCfgJjfdmSEV8hXsW1_:195tcha5k',
    },
    {
      name: '_uetvid',
      value: '80e2b590160f11eba3d1258dc474e078',
    },
    {
      name: '_uetsid',
      value: '80dfcd10160f11eba245e78686fd6d8f',
    },
    {
      name: 'mmapi.store.s.0',
      value: '%7B%22mmparams.d%22%3A%7B%7D%2C%22mmparams.p%22%3A%7B%7D%7D',
    },
    {
      name: 'mmapi.store.p.0',
      value: '%7B%22mmparams.d%22%3A%7B%7D%2C%22mmparams.p%22%3A%7B%22uat%22%3A%221635763831124%7C%7B%5C%22MostViewedCateg%5C%22%3A%5C%22brands%5C%22%7D%22%2C%22pd%22%3A%221635967208666%7C%5C%22-1672216986%7C4AMAAApVBAAEZAfotRMn%2FQADcGh4ARIAAUIArQWI9T4A7MzIeS2A2EjeL8uQIHjYSAAAAAD%2F%2F%2F%2F%2F%2F%2F%2F%2F%2FwAGRGlyZWN0Ab0TDQAxAAAAAAAAAILdAQCH3QEAgt0BAAQA9kgBAE4Q3X8MvxMA%2F%2F%2F%2F%2FwG%2FE78T%2F%2F8BAAABAAAAAAG2RAMAXS4EAAD1SAEAopOJPH26EwD%2F%2F%2F%2F%2FAbgTvxP%2F%2FzAAAAEAAAAAAbREAwBYLgQAAKJHAQAMK18Mt7sTAP%2F%2F%2F%2F8BuxO%2FE%2F%2F%2FEgAAAQAAAAAB7UADAFEpBAACht0BAAEAAACH3QEAHwAAAMNIAQCKyVFtx78TAP%2F%2F%2F%2F8BvxO%2FE%2F%2F%2FAQAAAQAAAAABKEQDAJ4tBAAAAAAAAAABRQ%3D%3D%5C%22%22%2C%22bid%22%3A%221604431808296%7C%5C%22prodphxcgeu01%5C%22%22%2C%22srv%22%3A%221635967208692%7C%5C%22prodphxcgeu01%5C%22%22%7D%7D',
    },
    {
      name: 'nlbi_949787',
      value: 'HAeHGNv8hwN/XoObb/11CwAAAACdhRJ8lv9mWr2QVxsg4SLx',
    },
    {
      name: '_gcl_au',
      value: '1.1.914210557.1603554131',
    },
    {
      name: 'WC_ACTIVEPOINTER',
      value: '-1%2C11352',
    },
    {
      name: 'BVImplmain_site',
      value: '2111',
    },
    {
      name: 'Apache',
      value: '170.225.181.248.1604421819179077',
    },
    {
      name: 'incap_ses_708_949787',
      value: 'eTqJIMCGwEhFZayXd1LTCR2joV8AAAAAfgxhGDpUK48H9nfJT40qVg==',
    },
    {
      name: '_bdccookie_coRetURL',
      value: 'https%3A%2F%2Fwww.boots.com%2Fsitesearch%3FsearchTerm%3Danti%2520perspirant%2520deodorant',
    },
    {
      name: 'incap_ses_740_949787',
      value: '2CRPB13YFCD1KlSHRwJFCmStoV8AAAAAL6nmNBfKnd7kCabEhnmi4g==',
    },
    {
      name: 'WC_GENERIC_ACTIVITYDATA',
      value: '[12767854717%3Atrue%3Afalse%3A0%3Aj7elBb624H2sGrBhM5LtAIQp2JA%3D][com.ibm.commerce.context.entitlement.EntitlementContext|12002%2612002%26null%26-2000%26null%26null%26null][com.ibm.commerce.context.audit.AuditContext|1603546063344-16580][com.ibm.commerce.context.globalization.GlobalizationContext|-1%26GBP%26-1%26GBP][com.ibm.commerce.store.facade.server.context.StoreGeoCodeContext|null%26null%26null%26null%26null%26null][com.ibm.commerce.catalog.businesscontext.CatalogContext|28501%26null%26false%26false%26false][com.ibm.commerce.context.experiment.ExperimentContext|null][com.ibm.commerce.context.ExternalCartContext|null][CTXSETNAME|Store][com.ibm.commerce.context.base.BaseContext|11352%26-1002%26-1002%26-1][com.ibm.commerce.giftcenter.context.GiftCenterContext|null%26null%26null]',
    },
    {
      name: 'selectedPrescriptionProductName',
      value: '',
    },
    {
      name: 'WC_PERSISTENT',
      value: 'DBFX8QsdnZUhq3cBA8lnVotTWtA%3D%0A%3B2020-11-03+16%3A43%3A39.215_1603546063344-16580_11352_-1002%2C-1%2CGBP_11352',
    },
    {
      name: 'WC_AUTHENTICATION_-1002',
      value: '-1002%2CFb4w3tP%2FTm0QcXyECvYb43eaB84%3D',
    },
    {
      name: 'WC_SESSION_ESTABLISHED',
      value: 'true',
    },
    {
      name: 'at',
      value: 'invalidated',
    },
    {
      name: 'WC_USERACTIVITY_-1002',
      value: '-1002%2C11352%2Cnull%2Cnull%2Cnull%2Cnull%2Cnull%2Cnull%2Cnull%2Cnull%2CLbaA6n4ADaBpJNzS8zUtG8ypwd4HOJiR1PwOiq%2BVz%2BetAX3bPwcQHpOMsNhhBvY9UzqIcZskhwNg%2F6i70T4Wiw8uCC0Ltbr2ZIy6cm6rxPCCtDqiFZO7eBcimWdpIAm1z%2FI%2BaaZwVc6RIPC%2Fp8z%2B6sgde%2Bq00sVpxSmPQOa1Gf5OIpWclGpkT1sf8ptIRTwRjpywL%2FElLBbx9CFAlx6Oug%3D%3D',
    },
    {
      name: '_ga',
      value: 'GA1.2.182717850.1603554140',
    },
    {
      name: 'cmTPSet',
      value: 'Y',
    },
    {
      name: '__gtm_referrer',
      value: 'https%3A%2F%2Fwww.google.com%2F',
    },
    {
      name: 'AMCV_F9D3ACB0580E2B510A495DC5%40AdobeOrg',
      value: '1278862251%7CMCIDTS%7C18566%7CMCMID%7C85647054670264328453648476617562008555%7CMCAAMLH-1604667280%7C12%7CMCAAMB-1604667280%7C6G1ynYcLPuiQxYZrsz_pkqfLG9yMXBpb2zX5dvJdYQJzPXImdj0y%7CMCOPTOUT-1604069680s%7CNONE%7CMCSYNCSOP%7C411-18567%7CvVersion%7C4.0.0',
    },
    {
      name: 'deepLinkVisited',
      value: 'true',
    },
    {
      name: 'sc.ASP.NET_SESSIONID',
      value: '4iamijlao5x1vgqjm4dvjdod',
    },
    {
      name: 'routeToPDPView',
      value: 'SLP',
    },
    {
      name: '_sctr',
      value: '1|1604082600000',
    },
    {
      name: 'rr_rcs',
      value: 'eF5jYSlN9jA0TkszMzM10k1KNUvSNTFOtdBNTk1N0TVNNk0xNUs2SzVIMubKLSvJTOEzNrLUNdQ1BACddA7J',
    },
    {
      name: 'DataLayerUserObject',
      value: '-1002%7C%7CNew%7Cfalse%7Cfalse%7C%7C',
    },
    {
      name: 'OptanonConsent',
      value: 'isIABGlobal=false&datestamp=Wed+Nov+04+2020+00%3A50%3A11+GMT%2B0530+(India+Standard+Time)&version=5.14.0&landingPath=NotLandingPage&groups=1%3A1%2C0_99631%3A1%2C0_133217%3A1%2C2%3A1%2C0_141865%3A1%2C0_99632%3A1%2C0_133218%3A1%2C3%3A1%2C4%3A1%2C0_99633%3A1%2C0_99634%3A1%2C0_99635%3A1%2C0_99636%3A1%2C0_99637%3A1%2C0_99638%3A1%2C0_99639%3A1%2C0_99640%3A1%2C0_99641%3A1%2C0_99642%3A1%2C0_99643%3A1%2C0_99644%3A1%2C0_127512%3A1%2C0_127513%3A1%2C0_127514%3A1%2C0_132622%3A1%2C0_132623%3A1%2C0_132624%3A1%2C0_133216%3A1%2C0_133219%3A1%2C0_133220%3A1%2C0_133284%3A1%2C0_138949%3A1%2C0_138950%3A1%2C0_138951%3A1%2C0_138952%3A1%2C0_138953%3A1%2C0_138954%3A1%2C0_141350%3A1%2C0_133309%3A1%2C0_145819%3A1%2C0_147929%3A1%2C0_141672%3A1%2C0_145820%3A1%2C0_147930%3A1%2C0_99646%3A1&AwaitingReconsent=false&consentId=92ac351d-d824-4f78-9542-99f1931a4acd',
    },
    {
      name: '_taggstar_exp',
      value: 'v:3|id:tvc2|group:treatment',
    },
    {
      name: 'incap_ses_712_949787',
      value: 'lezzaEF0E3HyhXHeYYjhCdZvoV8AAAAAHnBp9LRLuMqOp6KsBO1Psg==',
    },
    {
      name: '_bdccookie_bsktSumm',
      value: '%7Bpp%3A0%2Crc%3AN%2Cbt%3A0.00%2Cpt%3A0.00%2Capt%3A0%2Cbi%3A0%2Cpi%3A0%2Cli%3AN%2Cbp%3A0%2Cvd%3Afalse%2Cve%3Afalse%2CCRM%3Aonline%7D',
    },
    {
      name: 'QueueITAccepted-SDFrts345E',
      value: 'EventId%3Djunetech2020%26QueueId%3D58600662-6c4b-478b-aed9-45f643961047%26IsCookieExtendable%3Dtrue%26Expires%3D1604432410%26Hash%3Db8c3de90f02bb55f553685cd824a965cfc27de85bf7732ba7affed30f75143e0',
    },
    {
      name: 'UserType',
      value: 'G',
    },
    {
      name: 'incap_ses_747_949787',
      value: 'kIAcKvWB7SJ9C8W4tOBdCihpoV8AAAAAoHjZ+WY+gjD6xMKFmdzRag==',
    },
    {
      name: 'WC_DeleteCartCookie_11352',
      value: 'true',
    },
    {
      name: 'BVBRANDID',
      value: 'ce178103-cb30-47c4-b3f2-1eefb622db55',
    },
    {
      name: '_ALGOLIA',
      value: 'anonymous-d748e3dc-0ba8-4809-8d93-3bc263165838',
    },
    {
      name: 'gmid',
      value: '5h4SXrMYMI5YcKvulxlSyOcWvgb24q6MdXGGwKioyjQ',
    },
    {
      name: 'aam_uuid',
      value: '85357028430623069553607071707349352493',
    },
    {
      name: 'DataLayerLoginOption',
      value: 'Guest',
    },
    {
      name: 'selectedPrescriptionProductID',
      value: '',
    },
    {
      name: 'OneTrustPrevious',
      value: 'isIABGlobal=false&datestamp=Wed+Nov+04+2020+00:50:11+GMT+0530+(India+Standard+Time)&version=5.14.0&landingPath=NotLandingPage&groups=1:1,0_99631:1,0_133217:1,2:1,0_141865:1,0_99632:1,0_133218:1,3:1,4:1,0_99633:1,0_99634:1,0_99635:1,0_99636:1,0_99637:1,0_99638:1,0_99639:1,0_99640:1,0_99641:1,0_99642:1,0_99643:1,0_99644:1,0_127512:1,0_127513:1,0_127514:1,0_132622:1,0_132623:1,0_132624:1,0_133216:1,0_133219:1,0_133220:1,0_133284:1,0_138949:1,0_138950:1,0_138951:1,0_138952:1,0_138953:1,0_138954:1,0_141350:1,0_133309:1,0_145819:1,0_147929:1,0_141672:1,0_145820:1,0_147930:1,0_99646:1&AwaitingReconsent=false&consentId=92ac351d-d824-4f78-9542-99f1931a4acd',
    },
    {
      name: '_pin_unauth',
      value: 'dWlkPVlUQTJabVJsWmprdE1UYzVNeTAwWkdJNExUbGpOMk10TUdRNE16RXlaakV4TkdZNQ',
    },
    {
      name: '_scid',
      value: '0a41cfd0-389a-4c3e-92fb-cf6a0144abfd',
    },
    {
      name: '_gid',
      value: 'GA1.2.816963216.1603554140',
    },
    {
      name: '_taggstar_vid',
      value: '9d020482-160f-11eb-a08b-7bef14b2b5c4',
    },
    {
      name: 'visid_incap_949787',
      value: 'G//f/zz9Q3uvSAUE2CGJk8ErlF8AAAAAQUIPAAAAAAAJ7RpbDwzQAmNHw4IAupg1',
    },
    {
      name: 'OptanonAlertBoxClosed',
      value: '2020-10-24T15:33:32.478Z',
    },
    {
      name: 'sc.UserId',
      value: 'e4236297-6645-4fbc-b472-d59997d2a71d',
    },
    {
      name: 'gig_bootstrap_3_tgWZjPmf4Y0eeO0Okf-Cl3OjuaTNMW5aSIYEi0dY66KmwQXWyItwHA1Kb_uGmB9r',
      value: 'account_ver3',
    },
    {
      name: 'userVisitId',
      value: 'oi3w-1604413753823-851d',
    },
    {
      name: '90208333_clogin',
      value: 'l=54316971604428241435&v=1&e=1604430202394',
    },
    {
      name: 'DISPLAYNAME',
      value: 'guest',
    },
    {
      name: 'ADRUM',
      value: 's=1604428781064&r=https%3A%2F%2Fwww.boots.com%2Fsoltan-protect-and-moisturise-mini-spray-spf15-75ml-mini-10245687%3F0',
    },
    {
      name: 'CoreID6',
      value: '30119070816216035460565&ci=90208333',
    },
  );
  const { transform } = parameters;
  const { productDetails } = dependencies;
  async function getVideoLinks() {
    const iframe = document.querySelector('div.videoContainer iframe');
    if (!iframe) return;
    const response = await fetch(document.querySelector('div.videoContainer iframe').src);
    const html = await response.text();
    const doc = new DOMParser().parseFromString(html, 'text/html');
    const videoElements = Array.from(doc.querySelectorAll('[id^=isitetv_nav_item_nav_ul] > li > a'));
    const videoLinks = videoElements.map(elm => elm.getAttribute('onclick').match(/log_action\(\d+,\d+,\d+,\d+,\d+,(\d+)/)[1])
      .map(elm => `http://flv.isitetv.com/media/video/1499/video_url_${elm}_1499.m4v`).join('|');
    document.body.setAttribute('video-links', videoLinks);
    return videoLinks;
  }
  await context.evaluate(getVideoLinks);
  await context.evaluate(() => {
    if (!document.querySelector('li[id^="size_combo_button_pdp"][onclick]')) {
      document.body.classList.add('no-variants');
    }
  });
  return await context.extract(productDetails, { transform });
}


module.exports = {
  implements: 'product/details/extract',
  parameterValues: {
    country: 'UK',
    store: 'boots',
    transform,
    domain: 'boots.com',
    zipcode: '',
  },
  implementation,
};
